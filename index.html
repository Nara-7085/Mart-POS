<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>POS Mart | Professional Stock Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.net.min.js"></script>
  </head>
  <body>
    <div id="vanta-canvas"></div>

    <div class="sidebar shadow">
      <div class="p-4 border-bottom border-secondary mb-2">
        <h5 class="text-white fw-bold mb-0">
          <i class="fas fa-store text-primary me-2"></i> POS MART
        </h5>
        <small class="text-muted d-block mt-1">Professional Stock Control</small>
      </div>
      <nav class="nav flex-column">
        <div class="section-label">üì¶ Inventory</div>
        <a class="nav-link" href="./index.html"><i class="fas fa-barcode"></i> Products</a>
        <a class="nav-link" href="./Categories.html"><i class="fas fa-list"></i> Categories</a>
        <a class="nav-link" href="./Brands.html"><i class="fas fa-copyright"></i> Brands</a>
        <div class="section-label">‚öôÔ∏è Operations</div>
        <a class="nav-link" href="./Movements.html"><i class="fas fa-exchange-alt"></i> Movements</a>
        <a class="nav-link" href="./Transfers.html"><i class="fas fa-shuttle-van"></i> Transfers</a>
        <a class="nav-link" href="./Adjustments.html"><i class="fas fa-tools"></i> Adjustments</a>
        <div class="section-label">üë• People & Places</div>
        <a class="nav-link" href="./Suppliers.html"><i class="fas fa-truck"></i> Suppliers</a>
        <a class="nav-link" href="./Warehouses.html"><i class="fas fa-warehouse"></i> Warehouses</a>
      </nav>
    </div>

    <main class="main-content">
      <header class="navbar navbar-expand-lg navbar-light bg-white border-bottom px-4 py-3 sticky-top">
        <div class="container-fluid">
          <span class="navbar-brand fw-bold text-secondary"><i class="fas fa-chart-line me-2"></i>Inventory Dashboard</span>
          <button class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#modalInsert" id="addProductBtn">
            <i class="fas fa-plus me-2"></i>Add Product
          </button>
        </div>
      </header>

      <div class="container-fluid p-4">
        <div class="row g-4 mb-4" id="stats-container"></div>
        <div class="card border-0 shadow-sm rounded-3">
          <div class="card-header bg-white border-bottom p-3 d-flex justify-content-between align-items-center">
            <h6 class="fw-bold mb-0">Current Inventory</h6>
            <input type="text" id="searchInput" class="form-control w-25" placeholder="Search products..." />
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="ps-4">Product Name</th>
                    <th>Category</th>
                    <th>Brand</th>
                    <th>Price (Buy/Sell)</th>
                    <th>Stock</th>
                    <th class="text-end pe-4">Actions</th>
                  </tr>
                </thead>
                <tbody id="productTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div class="modal fade" id="modalInsert" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i> Create New Product</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="formCreateProduct">
            <div class="modal-body p-4">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label small fw-bold">Barcode</label>
                  <input type="text" class="form-control" name="barcode" />
                </div>
                <div class="col-md-6">
                  <label class="form-label small fw-bold">Product Name</label>
                  <input type="text" class="form-control" name="product_name" required />
                </div>

                <div class="col-md-6">
                  <label class="form-label small fw-bold">Category</label>
                  <select class="form-select" name="category" id="catSelect"></select>
                  <div class="mt-3">
                    <label class="form-label small fw-bold">Product Picture</label>
                    <div class="upload-container border rounded-3 p-3 text-center bg-light" 
                         onclick="document.getElementById('productImageInput').click()" 
                         style="cursor: pointer; border-style: dashed !important;">
                      <i class="fas fa-camera fa-2x text-muted mb-2"></i>
                      <p class="small text-muted mb-0">Upload Image</p>
                      <input type="file" id="productImageInput" name="product_image" hidden accept="image/*">
                    </div>
                  </div>
                </div>

                <div class="col-md-6">
                  <label class="form-label small fw-bold">Brand</label>
                  <select class="form-select mb-3" name="brand" id="brandSelect"></select>
                  <div class="d-flex align-items-end gap-3">
                    <div class="image-preview-box border rounded-3 bg-white d-flex align-items-center justify-content-center" 
                         style="width: 120px; height: 120px; overflow: hidden;">
                      <img id="imgPreview" src="#" alt="Preview" style="display: none; width: 100%; height: 100%; object-fit: contain;" />
                      <span id="previewText" class="text-muted small">No Image</span>
                    </div>
                    <div class="flex-grow-1">
                      <label class="form-label small fw-bold">Reorder</label>
                      <input type="number" class="form-control" name="reorder_level" required />
                    </div>
                  </div>
                </div>

                <div class="col-md-4">
                  <label class="form-label small fw-bold">Cost ($)</label>
                  <input type="number" step="0.01" class="form-control" name="cost_price" required />
                </div>
                <div class="col-md-4">
                  <label class="form-label small fw-bold">Sell ($)</label>
                  <input type="number" step="0.01" class="form-control" name="selling_price" required />
                </div>
                <div class="col-md-4">
                  <label class="form-label small fw-bold">Qty</label>
                  <input type="number" class="form-control" name="qty_in_stock" required />
                </div>
              </div>
            </div>
            <div class="modal-footer bg-light">
              <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary px-4">Save Product</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Image Preview Logic
      document.getElementById('productImageInput').onchange = function (evt) {
        const [file] = this.files;
        if (file) {
          const imgPreview = document.getElementById('imgPreview');
          const previewText = document.getElementById('previewText');
          imgPreview.src = URL.createObjectURL(file);
          imgPreview.style.display = 'block';
          previewText.style.display = 'none';
        }
      };
    </script>

    <script>
      // Fetch and display brands (populates brand select and a small list)
      async function loadBrands() {
        try {
          const res = await fetch('/api/brands');
          const json = await res.json();
          if (!json.success) return console.error('Failed to load brands', json);
          const brands = json.data || [];

          // populate brand select in product modal
          const brandSelect = document.getElementById('brandSelect');
          if (brandSelect) {
            brands.forEach(b => {
              const opt = document.createElement('option');
              opt.value = b._id;
              opt.textContent = b.brand_name || b.name || 'Unnamed';
              brandSelect.appendChild(opt);
            });
          }

          // display a simple brands card in the stats area
          const stats = document.getElementById('stats-container');
          if (stats) {
            const card = document.createElement('div');
            card.className = 'col-12';
            card.innerHTML = `<div class="card p-3"><h6>Brands (${brands.length})</h6><ul id="brandList" class="list-group list-group-flush"></ul></div>`;
            stats.appendChild(card);
            const brandList = document.getElementById('brandList');
            brands.forEach(b => {
              const li = document.createElement('li');
              li.className = 'list-group-item';
              li.textContent = `${b.brand_name || b.name} ‚Äî ${b.description || ''}`;
              brandList.appendChild(li);
            });
          }
        } catch (err) {
          console.error(err);
        }
      }
      loadBrands();
    </script>
    <script src="./network.js"></script>
  </body>
</html>